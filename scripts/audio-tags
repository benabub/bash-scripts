#!/bin/bash

# Check arguments
if [ $# -lt 1 ]; then
	TARGET_DIR="."
else
	TARGET_DIR="$1"
fi

# Get absolute path
TARGET_DIR=$(realpath "$TARGET_DIR")

# Function to clean string
clean_string() {
	echo "$1" | sed -e 's/^[^a-zA-Zа-яА-Я0-9]*//' -e 's/[^a-zA-Zа-яА-Я0-9]*$//' | tr -s '[:space:]_-' ' '
}

# Main processing
for artist_dir in "$TARGET_DIR"/*/; do
	if [ -d "$artist_dir" ]; then
		ARTIST_NAME=$(clean_string "$(basename "$artist_dir")")
		echo "Processing artist: $ARTIST_NAME"
		
		find "$artist_dir" -type f \( -iname "*.mp3" -o -iname "*.MP3" \) -print0 | while IFS= read -r -d $'\0' file; do
			# Get file info
			DIR_PATH=$(dirname "$file")
			ALBUM=$(clean_string "$(basename "$DIR_PATH")")
			TITLE=$(clean_string "$(basename "$file" | sed 's/\.[^.]*$//')")
			
			# Extract track number
			TRACK_NUM=""
			if [[ "$TITLE" =~ ^[0-9]+ ]]; then
				TRACK_NUM=$(echo "$TITLE" | grep -o '^[0-9]\+')
				TITLE=$(echo "$TITLE" | sed "s/^$TRACK_NUM[[:space:]]*-*[[:space:]]*//")
			fi
			
			# Extract year from album
			if [[ "$ALBUM" =~ (19[0-9]{2}|20[0-9]{2}) ]]; then
				YEAR="${BASH_REMATCH[1]}"
				ALBUM=$(echo "$ALBUM" | sed "s/$YEAR//" | xargs)
				ALBUM="$YEAR $ALBUM"
			fi
			
			# Remove all existing tags first
			id3v2 --delete-all "$file" >/dev/null 2>&1
			
			# Write ID3v2.3 tags with UTF-8 encoding
			id3v2 \
				--artist "$ARTIST_NAME" \
				--album "$ALBUM" \
				--song "$TITLE" \
				${TRACK_NUM:+--track "$TRACK_NUM"} \
				--year "$YEAR" \
				--TALB "$ALBUM" \
				--TIT2 "$TITLE" \
				--TPE1 "$ARTIST_NAME" \
				--TCOM "$ARTIST_NAME" \
				"$file" >/dev/null 2>&1
			
			# Verify tags
			echo "Processed: $(basename "$file")"
			echo "	Artist: $ARTIST_NAME"
			echo "	Album: $ALBUM"
			echo "	Title: $TITLE"
			[ -n "$TRACK_NUM" ] && echo "	Track: $TRACK_NUM"
			echo "------------------------------------"
		done
	fi
done

# Clean cmus cache
rm -rf ~/.config/cmus/lib.pl
echo "Cmus cache cleared. Please restart cmus and update library."
